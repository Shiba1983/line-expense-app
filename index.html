<!DOCTYPE html>
<html>
<head>
    <title>Travel Expense Splitter</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        button {
            background: #06c755;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>âœˆï¸ Travel Expense Splitter</h1>
    
    <div id="loading" class="card">
        <p>Loading app...</p>
        <p id="status">Initializing...</p>
    </div>
    
    <div id="app" style="display: none;">
        <div class="card">
            <h3>â• Add New Expense</h3>
            
            <label>Category:</label>
            <select id="category">
                <option value="Food">ğŸ” Food & Drinks</option>
                <option value="Transport">ğŸš— Transportation</option>
                <option value="Accommodation">ğŸ¨ Accommodation</option>
                <option value="Other">ğŸ“ Other</option>
            </select>
            
            <label>Amount:</label>
            <input type="number" id="amount" placeholder="Enter amount">
            
            <label>Currency:</label>
            <select id="currency">
                <option value="THB">ğŸ‡¹ğŸ‡­ THB</option>
                <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
                <option value="EUR">ğŸ‡ªğŸ‡º EUR</option>
            </select>
            
            <label>Paid By:</label>
            <select id="paidBy"></select>
            
            <label>Split Between:</label>
            <div id="participants"></div>
            
            <button onclick="submitExpense()">â• Add Expense</button>
            
            <div id="message"></div>
        </div>
        
        <div class="card">
            <h3>ğŸ“Œ How to Use</h3>
            <ol>
                <li>Select expense details</li>
                <li>Choose who paid</li>
                <li>Select people to split with</li>
                <li>Click "Add Expense"</li>
            </ol>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        // âš ï¸ REPLACE THESE TWO LINES âš ï¸
        const API_URL = 'https://script.google.com/macros/s/AKfycbymZ-qiE2gLMT3wSo_hKJZwVLnqCLD_Xzom6XbbYSanh5cuEY0bOCVrkjk7nPPWvBkqWg/exec';
        const LIFF_ID = '2008858986-uLQlNN1S';
        
        // ========== INITIALIZE APP ==========
        async function initApp() {
            try {
                // Step 1: Initialize LIFF
                document.getElementById('status').textContent = 'Initializing LIFF...';
                await liff.init({ liffId: LIFF_ID });
                
                // Step 2: Check login
                document.getElementById('status').textContent = 'Checking login...';
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                // Step 3: Test API connection
                document.getElementById('status').textContent = 'Connecting to Google Sheets...';
                const testResponse = await fetch(API_URL + '?action=test');
                if (!testResponse.ok) {
                    throw new Error('Cannot connect to Google Sheets');
                }
                
                // Step 4: Load participants
                document.getElementById('status').textContent = 'Loading participants...';
                const participantsResponse = await fetch(API_URL + '?action=getParticipants');
                const participantsData = await participantsResponse.json();
                
                if (!participantsData.participants) {
                    throw new Error('No participants found');
                }
                
                // Populate paidBy dropdown
                const paidBySelect = document.getElementById('paidBy');
                participantsData.participants.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person;
                    option.textContent = person;
                    paidBySelect.appendChild(option);
                });
                
                // Create participant checkboxes
                const participantsDiv = document.getElementById('participants');
                participantsData.participants.forEach(person => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = person;
                    checkbox.checked = true;
                    checkbox.id = 'check_' + person;
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(' ' + person));
                    participantsDiv.appendChild(label);
                });
                
                // Show app
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
            } catch (error) {
                document.getElementById('status').textContent = 'Error: ' + error.message;
                document.getElementById('status').style.color = 'red';
                console.error('Error:', error);
            }
        }
        
        // ========== SUBMIT EXPENSE ==========
        async function submitExpense() {
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;
            const paidBy = document.getElementById('paidBy').value;
            const category = document.getElementById('category').value;
            
            // Get selected participants
            const checkboxes = document.querySelectorAll('#participants input[type=checkbox]:checked');
            const selectedParticipants = Array.from(checkboxes).map(cb => cb.value);
            
            if (!amount || amount <= 0) {
                showMessage('Please enter a valid amount', 'error');
                return;
            }
            
            const expenseData = {
                action: 'saveExpense',
                category: category,
                payment: 'Cash',
                date: new Date().toISOString().split('T')[0],
                amount: parseFloat(amount),
                currency: currency,
                paidBy: paidBy,
                participants: selectedParticipants
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(expenseData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('âœ… Expense added successfully!', 'success');
                    document.getElementById('amount').value = '';
                } else {
                    showMessage('Error: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        }
        
        // ========== HELPER FUNCTIONS ==========
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = type;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
        
        // ========== START APP ==========
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
    </script>
</body>
</html>
